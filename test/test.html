<!DOCTYPE html>
<html>
  <head>
    <title>VideoJS Annotated Comments Test Page</title>
    <link href="video.js/dist/video-js.css" rel="stylesheet" />
    <link href="assets/videojs_skin.css" rel="stylesheet" />
    <link href="assets/page.css" rel="stylesheet" />
    <link href="css/annotations.css" rel="stylesheet" />
    <style>
      #options-panel {
        margin: 20px auto;
        width: 720px;
        background: #fff;
        border: 2px solid #0097b1;
        padding: 16px;
        text-align: left;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        font-size: 13px;
      }
      #options-panel h3 {
        margin: 0 0 12px;
        font-size: 15px;
        color: #0097b1;
        border-bottom: 1px solid #e2e2e2;
        padding-bottom: 8px;
      }
      #options-panel h4 {
        margin: 12px 0 6px;
        font-size: 13px;
        color: #555;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .opt-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 6px 16px;
      }
      .opt-row {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .opt-row label {
        cursor: pointer;
        user-select: none;
      }
      .opt-row input[type="checkbox"] {
        margin: 0;
      }
      .opt-inputs {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 6px 16px;
      }
      .opt-input label {
        display: block;
        font-size: 11px;
        color: #777;
        margin-bottom: 2px;
      }
      .opt-input input {
        width: 100%;
        padding: 4px 6px;
        border: 1px solid #ccc;
        border-radius: 3px;
        font-size: 12px;
        box-sizing: border-box;
      }
      #options-panel .btn-row {
        margin-top: 12px;
        display: flex;
        gap: 8px;
        align-items: center;
      }
      #options-panel button {
        background: #0097b1;
        color: #fff;
        border: none;
        padding: 6px 16px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 13px;
      }
      #options-panel button:hover { background: #007a91; }
      #options-panel button.secondary {
        background: #888;
      }
      #options-panel button.secondary:hover { background: #666; }
      #event-log {
        margin: 10px auto;
        width: 720px;
        max-height: 150px;
        overflow-y: auto;
        background: #1a1a2e;
        color: #0f0;
        font-family: monospace;
        font-size: 11px;
        padding: 8px;
        text-align: left;
        border-radius: 3px;
      }
      #event-log div { padding: 1px 0; }
      #event-log .ev-type { color: #0ff; }
    </style>
    <script>
      function guid() {
        function s4() {
          return Math.floor((1 + Math.random()) * 0x10000)
            .toString(16)
            .substring(1);
        }
        return (
          s4() + s4() + "-" + s4() + "-" + s4() + "-" + s4() + "-" + s4() + s4() + s4()
        );
      }
      // W3C Web Annotation Data Model format
      var ann1Id = guid(), ann2Id = guid(), ann3Id = guid(), ann4Id = guid();
      var annotations = [
        {
          "@context": "http://www.w3.org/ns/anno.jsonld",
          type: "Annotation", id: ann1Id, motivation: "commenting",
          body: { type: "TextualBody", value: 'Is the "Stories API" the only API we want to highlight here? It makes the system feel a little limited, even though we have robust functionality and multiple APIs', format: "text/plain" },
          target: { type: "SpecificResource", source: "contently-platform-overview.mp4", selector: { type: "FragmentSelector", conformsTo: "http://www.w3.org/TR/media-frags/", value: "t=55,60&xywh=percent:23.47,9.88,37.36,34.32" } },
          creator: { type: "Person", name: "Jack Pope", id: "1" },
          created: "2017-03-28T19:17:32.238Z"
        },
        {
          "@context": "http://www.w3.org/ns/anno.jsonld",
          type: "Annotation", id: ann2Id, motivation: "commenting",
          body: { type: "TextualBody", value: "Can we replace this logo with Microsoft?", format: "text/plain" },
          target: { type: "SpecificResource", source: "contently-platform-overview.mp4", selector: { type: "FragmentSelector", conformsTo: "http://www.w3.org/TR/media-frags/", value: "t=65&xywh=percent:0.97,65.19,35.28,32.09" } },
          creator: { type: "Person", name: "Evan Carothers", id: "2" },
          created: "2017-03-28T19:18:25.485Z"
        },
        {
          "@context": "http://www.w3.org/ns/anno.jsonld",
          type: "Annotation", id: guid(), motivation: "replying",
          body: { type: "TextualBody", value: "Great idea Evan, that's a SUPER recognizable brand!\n\nAny other major company brands we are missing in this shot?", format: "text/plain" },
          target: ann2Id,
          creator: { type: "Person", name: "Jack Pope", id: "1" },
          created: "2017-03-29T00:18:25.485Z"
        },
        {
          "@context": "http://www.w3.org/ns/anno.jsonld",
          type: "Annotation", id: ann3Id, motivation: "commenting",
          body: { type: "TextualBody", value: "Can we have a music change for this final section that transitions towards the final frame? Some sweet heavy rock 80s ballad?", format: "text/plain" },
          target: { type: "SpecificResource", source: "contently-platform-overview.mp4", selector: { type: "FragmentSelector", conformsTo: "http://www.w3.org/TR/media-frags/", value: "t=100" } },
          creator: { type: "Person", name: "Jack Pope", id: "1" },
          created: "2017-03-28T19:21:41.351Z"
        },
        {
          "@context": "http://www.w3.org/ns/anno.jsonld",
          type: "Annotation", id: ann4Id, motivation: "commenting",
          body: { type: "TextualBody", value: "The music is a little loud through this section and distracts from the content and narration a bit - can we tone 'er down a couple nocks here?", format: "text/plain" },
          target: { type: "SpecificResource", source: "contently-platform-overview.mp4", selector: { type: "FragmentSelector", conformsTo: "http://www.w3.org/TR/media-frags/", value: "t=21,61" } },
          creator: { type: "Person", name: "Evan Carothers", id: "2" },
          created: "2017-03-28T19:21:41.351Z"
        }
      ];
    </script>
  </head>
  <body>
    <div id="options-panel">
      <h3>Plugin Options</h3>

      <h4>UI</h4>
      <div class="opt-grid">
        <div class="opt-row"><input type="checkbox" id="opt-showControls" checked><label for="opt-showControls">showControls</label></div>
        <div class="opt-row"><input type="checkbox" id="opt-showCommentList" checked><label for="opt-showCommentList">showCommentList</label></div>
        <div class="opt-row"><input type="checkbox" id="opt-showFullScreen" checked><label for="opt-showFullScreen">showFullScreen</label></div>
        <div class="opt-row"><input type="checkbox" id="opt-showMarkerShapeAndTooltips" checked><label for="opt-showMarkerShapeAndTooltips">showMarkerShapeAndTooltips</label></div>
        <div class="opt-row"><input type="checkbox" id="opt-internalCommenting" checked><label for="opt-internalCommenting">internalCommenting</label></div>
        <div class="opt-row"><input type="checkbox" id="opt-startInAnnotationMode"><label for="opt-startInAnnotationMode">startInAnnotationMode</label></div>
        <div class="opt-row"><input type="checkbox" id="opt-bindArrowKeys" checked><label for="opt-bindArrowKeys">bindArrowKeys</label></div>
      </div>

      <h4>Permissions</h4>
      <div class="opt-grid">
        <div class="opt-row"><input type="checkbox" id="opt-allowAdd" checked><label for="opt-allowAdd">allowAdd</label></div>
        <div class="opt-row"><input type="checkbox" id="opt-allowEdit" checked><label for="opt-allowEdit">allowEdit</label></div>
        <div class="opt-row"><input type="checkbox" id="opt-allowDelete" checked><label for="opt-allowDelete">allowDelete</label></div>
        <div class="opt-row"><input type="checkbox" id="opt-restrictEditToOwner"><label for="opt-restrictEditToOwner">restrictEditToOwner</label></div>
        <div class="opt-row"><input type="checkbox" id="opt-restrictDeleteToOwner"><label for="opt-restrictDeleteToOwner">restrictDeleteToOwner</label></div>
      </div>

      <h4>Frame / Video / Identity</h4>
      <div class="opt-inputs">
        <div class="opt-input">
          <label for="opt-frameRate">frameRate (null to disable)</label>
          <input type="text" id="opt-frameRate" value="24">
        </div>
        <div class="opt-input">
          <label for="opt-videoSrc">videoSrc (override)</label>
          <input type="text" id="opt-videoSrc" value="" placeholder="auto-detect">
        </div>
        <div class="opt-input">
          <label for="opt-idPrefix">idPrefix</label>
          <input type="text" id="opt-idPrefix" value="" placeholder="e.g. urn:example:">
        </div>
        <div class="opt-input">
          <label for="opt-userId">meta.user_id</label>
          <input type="text" id="opt-userId" value="2">
        </div>
        <div class="opt-input">
          <label for="opt-userName">meta.user_name</label>
          <input type="text" id="opt-userName" value="John Smith">
        </div>
      </div>

      <div class="btn-row">
        <button onclick="REINIT()">Apply &amp; Reinitialize</button>
        <button class="secondary" onclick="CLEAR_LOG()">Clear Log</button>
      </div>
    </div>

    <div id="video_container">
      <video id="the_video" class="video-js" controls preload="auto" width="720" height="405" data-setup="{}">
        <source src="contently-platform-overview.mp4" type="video/mp4">
      </video>
    </div>

    <div id="event-log"></div>

    <script src="video.js/dist/video.min.js"></script>
    <script src="videojs-annotation.js"></script>
    <script>
      window.VAC_DEBUG = true;

      var player, plugin;
      var playerOptions = { controlBar: { volumePanel: { inline: false } } };

      function readOptions() {
        var fr = document.getElementById("opt-frameRate").value.trim();
        return {
          annotationsObjects: annotations,
          bindArrowKeys:              document.getElementById("opt-bindArrowKeys").checked,
          showControls:               document.getElementById("opt-showControls").checked,
          showCommentList:            document.getElementById("opt-showCommentList").checked,
          showFullScreen:             document.getElementById("opt-showFullScreen").checked,
          showMarkerShapeAndTooltips: document.getElementById("opt-showMarkerShapeAndTooltips").checked,
          internalCommenting:         document.getElementById("opt-internalCommenting").checked,
          startInAnnotationMode:      document.getElementById("opt-startInAnnotationMode").checked,
          allowAdd:                   document.getElementById("opt-allowAdd").checked,
          allowEdit:                  document.getElementById("opt-allowEdit").checked,
          allowDelete:                document.getElementById("opt-allowDelete").checked,
          restrictEditToOwner:        document.getElementById("opt-restrictEditToOwner").checked,
          restrictDeleteToOwner:      document.getElementById("opt-restrictDeleteToOwner").checked,
          frameRate:                  (fr && fr !== "null") ? parseFloat(fr) : null,
          videoSrc:                   document.getElementById("opt-videoSrc").value.trim() || null,
          idPrefix:                   document.getElementById("opt-idPrefix").value,
          meta: {
            user_id:   parseInt(document.getElementById("opt-userId").value, 10) || null,
            user_name: document.getElementById("opt-userName").value || null
          }
        };
      }

      function logEvent(type, data) {
        var el = document.getElementById("event-log");
        var line = document.createElement("div");
        var detail = "";
        if (data) {
          try { detail = " " + JSON.stringify(data).substring(0, 120); } catch(e) {}
        }
        line.innerHTML = '<span class="ev-type">' + type + '</span>' + detail;
        el.appendChild(line);
        el.scrollTop = el.scrollHeight;
      }

      function registerListeners(p) {
        var events = [
          "onStateChanged", "annotationOpened", "annotationClosed",
          "annotationAdded", "annotationDeleted", "annotationEdited",
          "commentAdded", "commentDeleted",
          "annotationModeEnabled", "annotationModeDisabled",
          "enteredAddingAnnotation", "addingAnnotationDataChanged",
          "playerBoundsChanged"
        ];
        events.forEach(function(ev) {
          p.registerListener(ev, function(event) {
            logEvent(ev, event.detail);
          });
        });
      }

      function INIT() {
        var opts = readOptions();
        player = videojs("the_video", playerOptions);
        player.ready(function() {
          plugin = player.annotationComments(opts);
          plugin.onReady(function() {
            logEvent("pluginReady", null);
          });
          registerListeners(plugin);
          player.muted(true);
          window.plugin = plugin;
        });
      }

      function REINIT() {
        if (plugin) {
          plugin.dispose();
          plugin = null;
        }
        if (player) {
          player.dispose();
          player = null;
        }
        // Recreate the video element
        var container = document.getElementById("video_container");
        container.innerHTML =
          '<video id="the_video" class="video-js" controls preload="auto" width="720" height="405" data-setup="{}">' +
          '<source src="contently-platform-overview.mp4" type="video/mp4">' +
          '</video>';
        INIT();
        logEvent("reinit", readOptions());
      }

      function CLEAR_LOG() {
        document.getElementById("event-log").innerHTML = "";
      }

      // Initial load
      INIT();
    </script>
  </body>
</html>
